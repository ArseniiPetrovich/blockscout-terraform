apiVersion: v1
kind: Service
metadata:
  name: bs-callisto-service-api
spec:
  type: LoadBalancer
  selector:
    app: bs
    chain: callisto
    type: api
  ports:
    - name: api
      protocol: TCP
      port: 80
      targetPort: 4000

apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: bs-callisto-api-scaler
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: blockscout-callisto-api
  targetCPUUtilizationPercentage: 80

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blockscout-callisto-api
  labels:
    app: bs
    chain: callisto
    type: api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bs
      chain: callisto
      type: api
  template:
    metadata:
      labels:
        app: bs
        chain: callisto
        type: api
    spec:
      initContainers:
      - name: db-migrations
        image: 758011127832.dkr.ecr.us-east-1.amazonaws.com/bs:latest
        envFrom:
        - configMapRef:
            name: env-callisto
        command: ['sh','-c','mix ecto.create && mix ecto.migrate'] 
      containers:
      - name: api
        resources:
          requests:
            memory: "1000Mi"
            cpu: "1000m"
        image: 758011127832.dkr.ecr.us-east-1.amazonaws.com/bs:latest
        env:
        - name: POOL_SIZE
          value: "10"
        - name: PORT
          value: "4000"
        envFrom:
        - configMapRef:
            name: env-callisto
        ports:
        - name: webport
          containerPort: 4000
